<div class="auth-card">
  <div class="auth-form-container">
    <div class="auth-form">
      <h2 class="text-center mb-4">Restablecer Contraseña</h2>

      <!-- Estado: Validando token (loading) -->
      @if (isLoading && !tokenChecked) {
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Validando enlace de recuperación...</p>
        </div>
      }

      <!-- Estado: Token inválido -->
      @if (tokenChecked && !isTokenValid && !resetSuccess) {
        <div class="alert alert-danger text-center">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Enlace inválido o expirado</strong>
          <p class="mb-3">Este enlace de recuperación no es válido o ha expirado.</p>
          <a routerLink="/forgot-password" class="btn btn-warning">
            Solicitar nuevo enlace
          </a>
        </div>
      }

      <!-- Estado: Token válido - Mostrar formulario -->
      @if (isTokenValid && !resetSuccess && tokenChecked) {
        <form [formGroup]="resetForm" (ngSubmit)="reset()">
          <div class="mb-3">
            <label for="password" class="form-label">Nueva contraseña</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-lock-fill"></i>
              </span>
              <input 
                type="password" 
                id="password" 
                formControlName="password" 
                class="form-control" 
                placeholder="Mínimo 8 caracteres"
                [class.is-invalid]="password.invalid && (password.dirty || password.touched)">
            </div>
            @if (password.invalid && (password.dirty || password.touched)) {
              <div class="text-danger">
                @if (password.hasError('required')) {<small>La nueva contraseña es obligatoria</small>}
                @if (password.hasError('minlength')) {<small>Debe tener al menos 8 caracteres</small>}
              </div>
            }
          </div>

          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-shield-lock-fill"></i>
              </span>
              <input 
                type="password" 
                id="confirmPassword" 
                formControlName="confirmPassword" 
                class="form-control" 
                placeholder="Repite la nueva contraseña"
                [class.is-invalid]="confirmPassword.invalid && (confirmPassword.dirty || confirmPassword.touched)">
            </div>
            @if (confirmPassword.invalid && (confirmPassword.dirty || confirmPassword.touched)) {
              <div class="text-danger"><small>La confirmación es obligatoria</small></div>
            }
            @if (resetForm.hasError('passwordsMismatch') && confirmPassword.valid && confirmPassword.touched) {
              <div class="text-danger"><small>⚠️ Las contraseñas no coinciden</small></div>
            }
          </div>

          <div class="d-grid">
            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="resetForm.invalid || isLoading">
              @if (isLoading) {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Actualizando...
              } @else {
                Actualizar contraseña
              }
            </button>
          </div>
        </form>
      }

      <!-- Estado: Contraseña actualizada exitosamente -->
      @else if (resetSuccess) {
        <div class="success-message text-center">
          <div class="success-icon text-success mb-3">
            <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
          </div>
          <h3 class="text-success">¡Contraseña actualizada!</h3>
          <p class="text-muted">Redirigiendo al inicio de sesión...</p>
          <div class="spinner-border text-success mt-3" role="status">
            <span class="visually-hidden">Redirigiendo...</span>
          </div>
        </div>
      }
    </div>
  </div>
</div>